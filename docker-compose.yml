# Event-Driven Order System â€” local run
# Usage: docker compose up
# Order-service is implemented; payment, inventory, notification are placeholders (optional to run).

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 5s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:29092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 5

  # One PostgreSQL per service (order-service only used for now)
  postgres-order:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: orderdb
      POSTGRES_USER: order
      POSTGRES_PASSWORD: order
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U order -d orderdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-payment:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: paymentdb
      POSTGRES_USER: payment
      POSTGRES_PASSWORD: payment
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payment -d paymentdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-inventory:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: inventorydb
      POSTGRES_USER: inventory
      POSTGRES_PASSWORD: inventory
    ports:
      - "5434:5432"
    profiles:
      - full

  postgres-notification:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: notificationdb
      POSTGRES_USER: notification
      POSTGRES_PASSWORD: notification
    ports:
      - "5435:5432"
    profiles:
      - full

  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    depends_on:
      kafka:
        condition: service_healthy
      postgres-order:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      POSTGRES_HOST: postgres-order
      POSTGRES_PORT: 5432
      POSTGRES_DB: orderdb
      POSTGRES_USER: order
      POSTGRES_PASSWORD: order
    ports:
      - "8080:8080"

  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    depends_on:
      kafka:
        condition: service_healthy
      postgres-payment:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      POSTGRES_HOST: postgres-payment
      POSTGRES_PORT: 5432
      POSTGRES_DB: paymentdb
      POSTGRES_USER: payment
      POSTGRES_PASSWORD: payment
    ports:
      - "8081:8080"

  # Optional: create topics explicitly (recommended for production-like setup)
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order.created --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order.created.dlt --partitions 1 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order.confirmed --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic order.confirmed.dlt --partitions 1 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic payment.confirmed --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic payment.failed --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic payment.refund.requested --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic inventory.reserved --partitions 6 --replication-factor 1
        kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic inventory.failed --partitions 6 --replication-factor 1
        echo "Topics created."
    profiles:
      - init
